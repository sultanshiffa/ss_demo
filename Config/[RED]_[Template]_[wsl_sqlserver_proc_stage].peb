{# -- TemplateVersion:001 MinVersion:8510 MaxVersion:* TargetType:SqlServer ModelType:* TemplateType:Procedure                                               -- #}
{# --                                                                                                                                                       -- #}
{# --    Â© WhereScape Inc 2024. WhereScape Inc permits you to copy this Template solely for use with the RED software, and to modify this Template          -- #}
{# --    for the purposes of using that modified Template with the RED software, but does not permit copying or modification for any other purpose.         -- #}
{# --                                                                                                                                                       -- #}
{# -- =============================================================================                                                                         -- #}
{# --                                                                                                                                                       -- #}
{# -- DBMS Name          : AzureSQL                                                                                                                         -- #}
{# -- Template Name      : wsl_sqlserver_proc_stage                                                                                                             -- #}
{# -- Template Version   : 8.1.1.0                                                                                                                          -- #}
{# -- Description        : This template creates a simple SQL Server procedure using Insert                                                                 -- #}
{# --                      specifically designed for RED multi source stage tables                                                                          -- #}
{# --                                                                                                                                                       -- #}
{# -- =============================================================================                                                                         -- #}
{# --                                                                                                                                                       -- #}
{# --                                                                                                                                                       -- #}
{# -- Notes / History                                                                                                                                       -- #}
{# --                                                                                                                                                       -- #}
{% import "wsl_sqlserver_utility_dml" %}
{% import "wsl_sqlserver_utility" %}
{# --                                                            Start of main procedure text                                                               -- #}
--=============================================================================={%br%}
-- DBMS Name        :    {{table.dbType.name}}{%br%}
-- Procedure Name   :    {{settings.procedureName}}{%br%}
-- Template         :    {{settings.template.name}}{%br%}
-- Template Version :    8.1.1.0{%br%}
-- Description      :    Update the {{table.objectType.name}} table {{table.name}}{%br%}
-- Generated by     :    {{env.productVersion}}{%br%}
-- Generated for    :    {{env.licensedTo}}{%br%}
-- Generated on     :    {{env.currentTimestamp}}{%br%}
-- Author           :    {{env.userName}}{%br%}
--=============================================================================={%br%}
-- Notes / History{%br%}
--{%br%}

{#- Set things up #}
{{- addProcedureHeader(settings.deleteBeforeInsert, settings.deleteBeforeInsertTruncate)}}{%br%}
{%- set v_addFlag = getExtendedProperty(propertyName = "Auto_Add_Flag") | trim | upper -%}{%br%}
{%- if v_addFlag == "Y" %}{%br%}
  {{- addProcedureCommentBlock(commentMessage = "Stage Table Variables")}}
{{- declareStageVariables()}}
{%- endif %}{%br%}
  {{- addProcedureCommentBlock(commentMessage = "MAIN")}}
  SET @v_step = {% counter %}00{%br%}{%br%}
  {%- if settings.deleteBeforeInsert and not settings.deleteBeforeInsertTruncate %}  SET @v_delete_count = 0{%br%} {%- endif %}
  SET @v_insert_count = 0{%br%}
  SET @v_update_count = 0{%br%}
  SET @v_dim_insert_count = 0{%br%}
  SET @v_current_datetime = GETDATE(){%br%}{%br%}
  BEGIN TRY{%br%}{%br%}

{#- Delete old records #}

{%- if settings.deleteBeforeInsert %}
    {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "Delete existing records")}}
    SET @v_step = {% counter %}00{%br%}{%br%}
  {%- if settings.deleteBeforeInsertTruncate %}
    SET @v_sql = N'TRUNCATE TABLE [TABLEOWNER].[{{table.name}}]';{%br%}
    EXEC @v_return_status = sp_executesql @v_sql{%br%}
  {%- else %}
    DELETE FROM [TABLEOWNER].[{{table.name}}]{%br%}
    {%- if settings.deleteWhereClause | trim != "" %}    {{settings.deleteWhereClause}}{%br%} {%- endif %}
    ;{%br%}{%br%}
    SELECT @v_delete_count = @@ROWCOUNT{%br%}
  {%- endif %}
{%- endif %}{%br%}

{#- Insert new records #}
{%-   set ind = "    " %}
{%br%}{%br%}

    {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "Insert new records")}}
    SET @v_step = {% counter %}00{%br%}{%br%}
    BEGIN TRANSACTION{%br%}{%br%}
      INSERT INTO [TABLEOWNER].[{{table.name}}]{%br%}
 {{ind}}{{- addSetInsertTargetColumns(indentString = "      ")}}
      ) {%br%}
      SELECT {{distinct()-}} {{addSetInsertColumns(indentString = "           ")}}
      {%- for joinLine in (settings.sourceJoinDetails.join | lines)%}      {{joinLine}}{%br%}{%- endfor%}
      {{- addDimensionJoins(indent = "  ")}}
      {%- for whereLine in (settings.sourceJoinDetails.where | trim | lines)%}      {{whereLine}}{%br%}{%- endfor%}
      {%- for groupByLine in (settings.sourceJoinDetails.groupBy | trim | lines)%}      {{groupByLine}}{%br%}{%- endfor%}
      ;{%br%}{%br%}
      SELECT @v_insert_count = @@ROWCOUNT{%br%}
    COMMIT{%br%}{%br%}

{%- if v_addFlag == "Y" %}{%br%}
    {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "Select all columns that fail at least one dimension join")}}
    DECLARE
    @p_{{ listSurrogateKeyColumns() }} integer{%br%}
    DECLARE c_Fix CURSOR LOCAL FOR{%br%}
    SELECT{{ addSetInsertTargetColumns(indentString = "      ") | slice(1) }}
    FROM [TABLEOWNER].[{{table.name}}]{%br%}
    WHERE {{ listSurrogateKeyColumns() }} = 0{%br%}
    FOR UPDATE {%br%}{%br%}

    {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "Loop through all the failed records.")}}
    SET @v_step = {% counter %}00{%br%}
    BEGIN TRANSACTION{%br%}{%br%}
    OPEN c_Fix{%br%}
    FETCH NEXT FROM c_Fix INTO{%br%}
    {{- fetchStageVariables()}}
    WHILE @@FETCH_STATUS = 0{%br%}{%br%}
    BEGIN {%br%}{%br%}
      {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "Lookup the dimension key from dimension table")}}
      IF @v_stage_{{ listSurrogateKeyColumns() }} = 0
      BEGIN {%br%}
        SET @v_step = {% counter %}00{%br%}
        SET @p_{{ listSurrogateKeyColumns() }} = NULL;
        SELECT @p_{{ listSurrogateKeyColumns() }}= {{ listSurrogateKeyColumns(indentString = "") }}{%br%}
        FROM   [TABLEOWNER].[{{listSurrogateKeyColumnssourcetable()}}]
        WHERE  {{ listDimBusinessKeyColumns() }} = @v_stage_{{ listDimBusinessKeyColumns() }}

        IF @p_{{ listSurrogateKeyColumns() }} IS NULL
          BEGIN TRANSACTION{%br%}
          INSERT INTO [TABLEOWNER].[{{listSurrogateKeyColumnssourcetable()}}]
          (
          {{ listDimBusinessKeyColumns() }}{%br%}
          {{ dssDimColumns() }}
          )
          VALUES
          ( @v_stage_{{ listDimBusinessKeyColumns()}}{%br%}
          {{ getdateForDss() }}
          )
          SELECT @p_{{ listSurrogateKeyColumns() }} = @@IDENTITY -- get last inserted key value
          COMMIT{%br%}
          SET @p_status = 2{%br%}{%br%}
          BEGIN {%br%}
            SET @v_dim_insert_count = @v_dim_insert_count + 1
          END {%br%}
      END {%br%}{%br%}

      {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "Update the stage table")}}
      SET @v_step = {% counter %}00{%br%}
      UPDATE [TABLEOWNER].[{{table.name}}]{%br%}
      SET {{ listSurrogateKeyColumns() }} = @p_{{ listSurrogateKeyColumns() }}{%br%}
      WHERE CURRENT OF c_Fix{%br%}{%br%}
      SELECT @v_update_count = @v_update_count + @@ROWCOUNT{%br%}{%br%}
      FETCH NEXT FROM c_Fix INTO{%br%}
      {{- fetchStageVariables()}}
    END {%br%}
    CLOSE c_Fix{%br%}
    DEALLOCATE c_Fix{%br%}
    COMMIT{%br%}
{%- endif %}{%br%}
{#- Finish Up #}

    {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "All Done report the results")}}
    SET @v_step = {% counter %}00{%br%}{%br%}
{%- if v_addFlag == "Y" %}{%br%}
  {{- addReturnMessage(settings.deleteBeforeInsert, settings.deleteBeforeInsertTruncate, addMerge = FALSE, addInsert = TRUE, addUpdate = TRUE, addDimInsert = TRUE)}}{%br%}
{%- else %}
  {{- addReturnMessage(settings.deleteBeforeInsert, settings.deleteBeforeInsertTruncate, addMerge = FALSE, addInsert = TRUE, addUpdate = TRUE, addDimInsert = FALSE)}}
{%- endif %}{%br%}
  END TRY{%br%}
  {{- addProcedureException() -}}
