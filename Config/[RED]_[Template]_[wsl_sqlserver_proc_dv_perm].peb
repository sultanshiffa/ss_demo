{# -- TemplateVersion:001 MinVersion:8510 MaxVersion:* TargetType:SqlServer ModelType:* TemplateType:Procedure                                               -- #}
{# --                                                                                                                                                       -- #}
{# --    Â© 2020 WhereScape Inc. WhereScape Inc permits you to copy this Template solely for use with the RED software, and to modify this Template          -- #}
{# --    for the purposes of using that modified Template with the RED software, but does not permit copying or modification for any other purpose.         -- #}
{# --                                                                                                                                                       -- #}
{# -- =============================================================================                                                                         -- #}
{# --                                                                                                                                                       -- #}
{# -- DBMS Name          : AzureSQL                                                                                                                       -- #}
{# -- Template Name      : wsl_sqlserver_proc_dv_perm                                                                                                       -- #}
{# -- Template Version   : 8.5.1.0                                                                                                                          -- #}
{# -- Description        : This template creates a SQL Server procedure using Insert                                                                        -- #}
{# --                      specifically designed for RED data vault permanent tables                                                                        -- #}
{# --                                                                                                                                                       -- #}
{# -- =============================================================================                                                                         -- #}
{# --                                                                                                                                                       -- #}
{# --                                                                                                                                                       -- #}
{# -- Notes / History                                                                                                                                       -- #}
{# --                                                                                                                                                       -- #}
{# -- BC 14/12/2017     Fixed to use the correct sourceJoinDetails associated with the Update or Custom procedure being built.                              -- #}
{# -- MM 02/04/2020     Added support for Multi-Active Satellites                                                                                           -- #}
{# --                                                                                                                                                       -- #}
{# --                                                                                                                                                       -- #}
{% import "wsl_sqlserver_utility_dv" %}
{# --                                                            Start of main procedure text                                                               -- #}
--=============================================================================={%br%}
-- DBMS Name        :    {{table.dbType.name}}{%br%}
-- Procedure Name   :    {{settings.procedureName}}{%br%}
-- Template         :    {{settings.template.name}}{%br%}
-- Template Version :    8.5.1.0{%br%}
-- Description      :    Update the {{table.objectType.name}} table {{table.name}}{%br%}
-- Generated by     :    {{env.productVersion}}{%br%}
-- Generated for    :    {{env.licensedTo}}{%br%}
-- Generated on     :    {{env.currentTimestamp}}{%br%}
-- Author           :    {{env.userName}}{%br%}
--=============================================================================={%br%}
-- Notes / History{%br%}
--{%br%}

  {#- Set things up #}

  {{- addProcedureHeader(false, false)}}{%br%}
  {{- addProcedureCommentBlock(commentMessage = "MAIN")}}
  {%- set isSatelliteMultiActiveSequence = false -%}
  {%- if table.objectType == Types.ObjectType.Satellite %}
    {%- from table.columns as multiActiveSeqColumn where multiActiveSeqColumn.keyType.name == "MultiActiveSequence" and multiActiveSeqColumn.sourceTable is empty -%}
      {%- set isSatelliteMultiActiveSequence = true -%}
    {%- endfrom -%}
  {%- endif %}


  SET @v_step = {% counter %}00{%br%}{%br%}
  SET @v_insert_count = 0{%br%}
  SET @v_current_datetime = GETDATE(){%br%}{%br%}

  BEGIN TRY{%br%}{%br%}
    {#- Insert new records #}

    {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "Insert new records")}}

    SET @v_step = {% counter %}00{%br%}{%br%}

    BEGIN TRANSACTION{%br%}{%br%}

    INSERT INTO [TABLEOWNER].[{{table.name}}]{%br%}
    {{- addSetInsertTargetColumns(indentString = "      ")}}
    {%- if isSatelliteMultiActiveSequence -%}{%br%}
    SELECT {{addSetInsertColumnsMultiActiveSequenceSatellite(indent = "      ")}}
    FROM ( {%br%}
      SELECT {{distinct()}}
    {%- else %}
    SELECT {{distinct()}}
    {%- endif -%}
    {%- if isSatelliteMultiActiveSequence -%}
    {{addSetInsertColumnsIncomingRowsMultiActiveSequenceSatellite(indent = "      ")}}
    {%- else -%}
    {{addSetInsertColumnsPerm(indentString = "           ")}}
    {%- endif -%}
    {%- if settings.sourceJoinDetails.join | trim != "" %}
    {{settings.sourceJoinDetails.join}}
    {%- endif %}{%br%}
    {%- if isSatelliteMultiActiveSequence %}
    ) AS incoming_rows {%br%}
    {%- endif -%}
    {%- if table.objectType == Types.ObjectType.Satellite and isSatelliteMultiActiveSequence -%}
    {{addSatMultiActiveSequenceCurrentVersion(indent="    ")}}
    {%- elseif table.objectType == Types.ObjectType.Satellite %}
    {{addSatCurrentVersion()}}
    {%- endif %}
    {%- if settings.sourceJoinDetails.where | trim != "" %}
    {{settings.sourceJoinDetails.where | trim }}{%br%}
    {%- endif %}
    {%- if table.objectType == Types.ObjectType.Hub %}
    {{addHubWhereNotExists()}}
    {%- elseif table.objectType == Types.ObjectType.Link %}
    {{addLinkWhereNotExists()}}
    {%- elseif table.objectType == Types.ObjectType.Satellite and isSatelliteMultiActiveSequence %}
    {{addMultiActiveSequenceSatWhereNotExists()}}
    {%- elseif table.objectType == Types.ObjectType.Satellite %}
    {{addSatWhereNotExists()}}
    {%- endif %}
    {%- if settings.sourceJoinDetails.groupBy | trim != "" %}
    {{settings.sourceJoinDetails.groupBy | trim }}{%br%}
    {%- endif %}
    ;{%br%}{%br%}

    SELECT @v_insert_count = @@ROWCOUNT{%br%}{%br%}
    COMMIT{%br%}{%br%}

    {#- Finish Up #}

    {{- addProcedureCommentBlock(indentString = "    ", commentMessage = "All Done report the results")}}
    SET @v_step = {% counter %}00{%br%}{%br%}
    {{- addReturnMessage(false, false)}}
  END TRY{%br%}
  {{- addProcedureException() -}}
